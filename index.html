<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TRASP Installations Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.css" rel="stylesheet">

  <style>
    body { margin:0; padding:0; font-family: sans-serif; }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 1;
      background: white; padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      max-width: 320px;
    }
    .panel label { display:block; margin: 8px 0 4px; font-size: 12px; }
    .panel select { width: 100%; padding: 4px; }

    /* Make popup scrollable */
    .mapboxgl-popup-content {
      max-height: 260px;
      overflow-y: auto;
      overflow-x: hidden;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <label for="typeSelect">Filter by Type</label>
    <select id="typeSelect">
      <option value="__all__">All</option>
    </select>

    <label for="countrySelect">Filter by Country</label>
    <select id="countrySelect">
      <option value="__all__">All</option>
    </select>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = "pk.eyJ1IjoicGphZmFyeSIsImEiOiJjbWttMnB1cWgwYm9yM2VvcjBsaDVjZjZ6In0.4hnFagy7O71f_AJTMS1guQ";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v12",
      center: [0, 20],
      zoom: 1.2,
      projection: "mercator"
    });

    // Force flat 2D and lock rotation/pitch
    map.on("style.load", () => {
      map.setProjection("mercator");
    });

    // Add zoom controls (no compass)
    map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), "top-right");

    // ---- YOUR DATA FIELD NAMES (must match GeoJSON exactly) ----
    const FIELD_TYPE = "Type";
    const FIELD_COUNTRY = "Installation type: Country"; // <-- your requested field
    const GEOJSON_FILE = "./data.geojson";

    const typeSelect = document.getElementById("typeSelect");
    const countrySelect = document.getElementById("countrySelect");

    function escapeHtml(val) {
      const s = String(val ?? "");
      return s.replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
    }

    function applyFilters() {
      const selectedType = typeSelect.value;
      const selectedCountry = countrySelect.value;

      const filters = ["all"];

      if (selectedType !== "__all__") {
        filters.push(["==", ["get", FIELD_TYPE], selectedType]);
      }
      if (selectedCountry !== "__all__") {
        filters.push(["==", ["get", FIELD_COUNTRY], selectedCountry]);
      }

      // Apply to your points layer
      map.setFilter("points-layer", filters.length > 1 ? filters : null);
    }

    // Create a custom “trap/tunnel-ish” icon using an inline SVG
    function addTrapIcon() {
      return new Promise((resolve) => {
        const svg = `
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
            <!-- outer circle -->
            <circle cx="32" cy="32" r="26" fill="#ffffff" stroke="#111111" stroke-width="4"/>
            <!-- tunnel arch -->
            <path d="M18 36c0-10 6-18 14-18s14 8 14 18v10H18V36z"
                  fill="#e9e9e9" stroke="#111111" stroke-width="3" />
            <!-- “trap” marker -->
            <path d="M32 20 L40 34 H24 Z" fill="#111111"/>
            <circle cx="32" cy="40" r="4" fill="#111111"/>
          </svg>
        `.trim();

        const img = new Image(32, 32);
        img.onload = () => {
          if (!map.hasImage("trapIcon")) {
            map.addImage("trapIcon", img, { pixelRatio: 2 });
          }
          resolve();
        };
        img.onerror = () => resolve(); // fallback: still resolve
        img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
      });
    }

    map.on("load", async () => {
      // Lock the basemap (no panning/dragging)
      map.dragPan.disable();
      map.touchPan.disable();
      map.doubleClickZoom.disable();   // optional: comment out if you want double click zoom
      map.boxZoom.disable();
      map.dragRotate.disable();
      map.touchZoomRotate.disableRotation();
      map.keyboard.disable();          // prevents arrow-key panning too
      map.setPitch(0);
      map.setBearing(0);
      map.setMaxPitch(0);

      // Load GeoJSON
      const res = await fetch(GEOJSON_FILE);
      const geojson = await res.json();

      // Populate dropdowns with unique values
      const types = new Set();
      const countries = new Set();

      for (const f of geojson.features) {
        const p = f?.properties || {};
        const t = p[FIELD_TYPE];
        const c = p[FIELD_COUNTRY];

        if (t !== undefined && t !== null && String(t).trim() !== "") types.add(String(t));
        if (c !== undefined && c !== null && String(c).trim() !== "") countries.add(String(c));
      }

      [...types].sort().forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        typeSelect.appendChild(opt);
      });

      [...countries].sort().forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        countrySelect.appendChild(opt);
      });

      map.addSource("points", { type: "geojson", data: geojson });

      // Add custom icon
      await addTrapIcon();

      // Use a SYMBOL layer with the custom icon
      map.addLayer({
        id: "points-layer",
        type: "circle",
        source: "points",
        paint: {
          "circle-radius": 5,
          "circle-stroke-width": 1
        }
      });

      // Fit map to all points once (worldwide)
      const bounds = new mapboxgl.LngLatBounds();
      for (const f of geojson.features) {
        const g = f.geometry;
        if (!g) continue;
        if (g.type === "Point") bounds.extend(g.coordinates);
        else if (g.type === "MultiPoint") g.coordinates.forEach(c => bounds.extend(c));
      }
      if (!bounds.isEmpty()) {
        map.fitBounds(bounds, { padding: 40, maxZoom: 10, duration: 0 });
      }

      // Popup on click (entries 7..66)
      map.on("click", "points-layer", (e) => {
        const p = e.features[0].properties || {};
        const html = Object.entries(p)
          .slice(7, 67)
          .map(([k,v]) => `<div><b>${escapeHtml(k)}</b>: ${escapeHtml(v)}</div>`)
          .join("");

        new mapboxgl.Popup({ maxWidth: "340px" })
          .setLngLat(e.lngLat)
          .setHTML(html || "<div>No fields to show</div>")
          .addTo(map);
      });

      map.on("mouseenter", "points-layer", () => map.getCanvas().style.cursor = "pointer");
      map.on("mouseleave", "points-layer", () => map.getCanvas().style.cursor = "");

      // Hook up filters
      typeSelect.addEventListener("change", applyFilters);
      countrySelect.addEventListener("change", applyFilters);
    });
  </script>
</body>
</html>

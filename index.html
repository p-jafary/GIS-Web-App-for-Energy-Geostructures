<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Energy Geostructures Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <link href="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.js"></script>

  <style>
    :root { --sidebar-w: 350px; }
    body { margin: 0; font-family: sans-serif; background: #f5f5f5; }
    .app {
      height: 100vh;
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      gap: 12px;
      padding: 12px;
      box-sizing: border-box;
    }
    .sidebar {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      padding: 12px;
      overflow: auto;
    }
    .map-panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    #map { width: 100%; height: 100%; }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <h1>Energy Geostructures</h1>

    <label for="countrySelect">Filter by Country</label>
    <select id="countrySelect">
      <option value="__all__">All</option>
    </select>

    <div id="typeLegend"></div>

    <button id="resetBtn">Reset</button>
    <button id="fitAllBtn">Fit all</button>

    <div id="statsBox"></div>
  </aside>

  <main class="map-panel">
    <div id="map"></div>
  </main>
</div>

<script>
mapboxgl.accessToken = "pk.eyJ1IjoicGphZmFyeSIsImEiOiJjbWttMnB1cWgwYm9yM2VvcjBsaDVjZjZ6In0.4hnFagy7O71f_AJTMS1guQ";

const FIELD_TYPE = "Type";
const FIELD_COUNTRY = "Installation type - Country";
const GEOJSON_FILE = "./data.geojson";

/* ================= TYPE CONFIG ================= */
const TYPE_UI = [
  { label: "Energy Barrettes",        dataValues: ["Barrettes trasp"],              marker: "purple" },
  { label: "Energy Anchors",          dataValues: ["Energy Anchors"],               marker: "red" },
  { label: "Energy Slabs",            dataValues: ["Energy Slab"],                  marker: "green" },
  { label: "Energy Sheet Pile Walls", dataValues: ["Energy sheet pile walls trasp"], marker: "purple" },
  { label: "Geothermal Pavements",    dataValues: ["Geothermal pavements"],         marker: "orange" },
  { label: "Energy Piles",            dataValues: ["Piles trasp"],                  marker: "blue" },
  { label: "Energy Tunnels",          dataValues: ["Tunnels trasp"],                marker: "teal" },
  { label: "Energy Retaining Walls",  dataValues: ["Walls trasp"],                  marker: "brown" }
];

function norm(v) { return String(v ?? "").trim(); }

/* ================= MAP INIT ================= */
const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/streets-v12",
  center: [0, 20],
  zoom: 1.2,
  projection: "mercator"
});

map.addControl(new mapboxgl.NavigationControl({ showCompass: false }));

/* ================= LOAD DATA & MARKERS ================= */
map.on("load", async () => {
  const geojson = await fetch(GEOJSON_FILE).then(r => r.json());

  map.addSource("points", { type: "geojson", data: geojson });

  /* ---------- Load marker images ---------- */
  const markerFiles = {
    purple: "./markers/purple.png",
    red: "./markers/red.png",
    green: "./markers/green.png",
    blue: "./markers/blue.png",
    orange: "./markers/orange.png",
    teal: "./markers/teal.png",
    brown: "./markers/brown.png",
    grey: "./markers/grey.png"
  };

  await Promise.all(
    Object.entries(markerFiles).map(([name, url]) =>
      new Promise((resolve, reject) => {
        map.loadImage(url, (err, img) => {
          if (err) reject(err);
          if (!map.hasImage(name)) map.addImage(name, img);
          resolve();
        });
      })
    )
  );

  /* ---------- Build icon match expression ---------- */
  const iconMatch = ["match", ["to-string", ["get", FIELD_TYPE]]];

  TYPE_UI.forEach(ui => {
    ui.dataValues.forEach(v => iconMatch.push(norm(v), ui.marker));
  });

  iconMatch.push("grey"); // fallback

  /* ---------- ADD LAYER ---------- */
  map.addLayer({
    id: "points-layer",
    type: "symbol",
    source: "points",
    layout: {
      "icon-image": iconMatch,
      "icon-size": 0.6,
      "icon-anchor": "bottom",
      "icon-allow-overlap": true
    }
  });

  /* ---------- Filters (unchanged logic) ---------- */
  document.getElementById("countrySelect").addEventListener("change", e => {
    const val = e.target.value;
    map.setFilter(
      "points-layer",
      val === "__all__"
        ? null
        : ["==", ["to-string", ["get", FIELD_COUNTRY]], val]
    );
  });

  document.getElementById("fitAllBtn").onclick = () => {
    const b = new mapboxgl.LngLatBounds();
    geojson.features.forEach(f => b.extend(f.geometry.coordinates));
    map.fitBounds(b, { padding: 60 });
  };
});
</script>
</body>
</html>

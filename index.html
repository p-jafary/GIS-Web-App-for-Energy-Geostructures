<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Energy Geostructures Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <link href="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.18.0/mapbox-gl.js"></script>

  <style>
    :root { --sidebar-w: 350px; }
    body { margin: 0; font-family: sans-serif; background: #f5f5f5; }
    .app {
      height: 100vh;
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      gap: 12px;
      padding: 12px;
      box-sizing: border-box;
    }
    .sidebar {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      padding: 12px;
      overflow: auto;
    }
    .sidebar h1 { font-size: 16px; margin: 0 0 8px; }
    .sidebar .hint { font-size: 12px; color: #555; margin: 0 0 12px; }
    .legend-swatch {
      width: 10px; height: 10px; border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.25);
    }
    .map-panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    #map { width: 100%; height: 100%; }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <h1>Energy Geostructures</h1>
    <label for="countrySelect">Filter by Country</label>
    <select id="countrySelect">
      <option value="__all__">All</option>
    </select>
    <div class="legend">
      <div class="legend-title">TYPES</div>
      <div id="typeLegend"></div>
    </div>
    <button id="resetBtn">Reset filters</button>
    <button id="fitAllBtn">Fit all points</button>
    <div id="statsBox"></div>
  </aside>
  <main class="map-panel">
    <div id="map"></div>
  </main>
</div>

<script>
mapboxgl.accessToken = "pk.eyJ1IjoicGphZmFyeSIsImEiOiJjbWttMnB1cWgwYm9yM2VvcjBsaDVjZjZ6In0.4hnFagy7O71f_AJTMS1guQ";

const FIELD_TYPE = "Type";
const FIELD_COUNTRY = "Installation type - Country";
const GEOJSON_FILE = "./data.geojson";

const TYPE_UI = [
  { label: "Energy Barrettes",        color: "#6A1B9A", dataValues: ["Barrettes trasp"], marker: "purple" },
  { label: "Energy Anchors",          color: "#C62828", dataValues: ["Energy Anchors"], marker: "red" },
  { label: "Energy Slabs",            color: "#2E7D32", dataValues: ["Energy Slab"], marker: "green" },
  { label: "Energy Sheet Pile Walls", color: "#8E24AA", dataValues: ["Energy sheet pile walls trasp"], marker: "purple" },
  { label: "Geothermal Pavements",    color: "#EF6C00", dataValues: ["Geothermal pavements"], marker: "orange" },
  { label: "Energy Piles",            color: "#1565C0", dataValues: ["Piles trasp"], marker: "blue" },
  { label: "Energy Tunnels",          color: "#00838F", dataValues: ["Tunnels trasp"], marker: "teal" },
  { label: "Energy Retaining Walls",  color: "#6D4C41", dataValues: ["Walls trasp"], marker: "brown" }
];

const TYPE_TO_MARKER = new Map();
TYPE_UI.forEach(ui => ui.dataValues.forEach(v => TYPE_TO_MARKER.set(v.trim(), ui.marker)));

const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/streets-v12",
  center: [0, 20],
  zoom: 1.2
});

map.on("load", async () => {

  const MARKERS = {
    purple: "./markers/marker-purple.png",
    red: "./markers/marker-red.png",
    green: "./markers/marker-green.png",
    blue: "./markers/marker-blue.png",
    orange: "./markers/marker-orange.png",
    teal: "./markers/marker-teal.png",
    brown: "./markers/marker-brown.png",
    grey: "./markers/marker-grey.png"
  };

  await Promise.all(Object.entries(MARKERS).map(([name, url]) =>
    new Promise((res, rej) => {
      map.loadImage(url, (e, img) => {
        if (e) rej(e);
        if (!map.hasImage(name)) map.addImage(name, img);
        res();
      });
    })
  ));

  const geojson = await fetch(GEOJSON_FILE).then(r => r.json());
  map.addSource("points", { type: "geojson", data: geojson });

  const iconMatch = ["match", ["to-string", ["get", FIELD_TYPE]]];
  for (const [type, marker] of TYPE_TO_MARKER.entries()) {
    iconMatch.push(type, marker);
  }
  iconMatch.push("grey");

  map.addLayer({
    id: "points-layer",
    type: "symbol",
    source: "points",
    layout: {
      "icon-image": iconMatch,
      "icon-size": 0.6,
      "icon-anchor": "bottom",
      "icon-allow-overlap": true
    }
  });
});
</script>
</body>
</html>
